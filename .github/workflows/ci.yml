name: CI
on:
  push:
    branches: [main, master]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - uses: actions/cache@v4
        with:
          path: |
            build/release
            ~/.cargo/registry
            ~/.cargo/git
          key: lean-build-${{ runner.os }}-${{ hashFiles('src/**/*.lean', 'src/**/*.cpp', 'src/**/*.h') }}
          restore-keys: |
            lean-build-${{ runner.os }}-

      - name: Build Lean
        run: nix develop -c make -j$(nproc) -C build/release

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Test Rust backend
        run: |
          nix develop -c ./build/release/stage1/bin/lean --rust-bin=test_fib ../tests/fib.lean
          ./test_fib
